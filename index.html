<!DOCTYPE html>
<html>
<head>
<title>jsMSX - The first MSX emulator 100% written in Javascript</title>
<style>
body {font-size:small; line-height:140%; padding:2px;}
table {font-size:small; line-height:140%; padding:2px;}
input[type=text] {width:100%;}
input#interrupts {width:auto;}
</style>
<!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
<script src="lib/jquery.min.js" type="text/javascript"></script>
<script src="source/msx.js" type="text/javascript"></script>
<script src="source/z80.js" type="text/javascript"></script>
<script src="source/keyboard.js" type="text/javascript"></script>
<script src="source/psg8910.js" type="text/javascript"></script>
<script src="source/tms9918.js" type="text/javascript"></script>
<script src="source/ui.js" type="text/javascript"></script>
<script src="express/msx1.rom.js" type="text/javascript"></script>
<script src="express/goonies.rom.js" type="text/javascript"></script>
</head>

<body>
  <div style="width:580px;margin:0 auto 0 auto;">
    <h2>jsMSX - The first MSX emulator 100% written in Javascript</h2>
    <p>
      jsMSX Copyright (c) 2006 Marcus Granado [mrc.gran(@)gmail.com] 
    </p>
    <div>
      <canvas id="canvas" name="canvas" width="256" height="192" style="border:medium solid;"></canvas>
      <br>
      <input id="start" value="start" onclick="msx_start();" type="button">
      <input id="stop" value="pause" disabled="true" onclick="msx_stop();" type="button">
      <input id="reset" value="reset" onclick="msx_reset();" type="button">
      Interrupts:
      <input id="interrupts" value="0" size="5" type="text">
    </div>
    <h2>To load arbitrary roms</h2>
    <p>Please load the ROM images before starting the emulator:</p>
    <p>
      1. <select id="bios" style="width:200px;"></select>
         <input id="loadbiosrom" value="Load BIOS ROM" onclick="msx_loadbiosrom();" type="button" style="width:130px;">
         <span id="current-bios"></span>
    </p>
    <p>
      2. <select id="games" style="width:200px;"></select>
         <input id="loadcartrom" value="Load Cartridge ROM" onclick="msx_loadcartrom();" type="button" style="width:130px;">
         <span id="current-game"></span>
    </p>
    <div>
      <pre style="border:medium solid;"><p id="logbuf">Console:</p></pre>
    </div>
  </div>

<script type="text/javascript">

getDirList("roms/bios/",  "#bios")
getDirList("roms/games/", "#games")

function getDirList(url, select) {
  $.ajax({
    url: url,
    complete: function(xhr, status) {
      console.log('Status:', status);
      if (status == 'success') {
        var html = xhr.responseText;
        var s = html.substring(html.indexOf("<table>"), html.indexOf("</table>")+8);
        var a = $('a', $(s));
        a.slice(5).each(function(index) {
          var f = $(this).text();
          console.log( index + ": " + f );
          if (f == "expert_1.0_basic-bios1.rom" || f == "ROAD.ROM") {
            $(select).append("<option selected>" + $(this).text() + "</option>");
          }
          else {
            $(select).append("<option>" + $(this).text() + "</option>");
          }
        });
      }
    }
  });
}



var mylogbuf = document.getElementById('logbuf');
var mycanvas = document.getElementById('canvas');
var mycanvasctx = mycanvas.getContext('2d');

$(mycanvas).animate({
  width: '512px',
  height: '384px'
});

var msx = new JSMSX(window, mycanvasctx, mylogbuf);
console.log(msx);
msx.reset();

//initializes msx with some bios roms
//just for demonstration purposes on webbrowsers
//in which file i/o is not supported yet for this demo.
//loads slot 0 with cbios 0.21 rom file [cbios.sourceforge.net]
for (var i = 0; i < 32768; i++) msx.cpu.memReadMap[0][i] = cbios_main_msx1_rom[i];
for (var i = 16384; i < 49152; i++) msx.cpu.memReadMap[2][i] = goonies_rom[i - 16384];

function msx_start() {
  msx.start();
  document.getElementById('start').disabled = true;
  document.getElementById('stop').disabled = false;
  document.getElementById('scale2x').disabled = true;
}

function msx_stop() {
  msx.stop();
  document.getElementById('start').disabled = false;
  document.getElementById('stop').disabled = true;
}

function msx_reset() {
  msx.reset();
  msx.interruptCounter = 0;
}

function msx_showpc() {
  msx.cpu.showpc = true;
}

function msx_loadbiosrom() {
  var f = escape($("#bios").val());
  getRomData('roms/bios/' + f, function(res) {
    msx.loadBios(res, 0);
    $("#current-bios").text(f);
  });
}

function msx_loadcartrom() {
  var f = escape($("#games").val());
  getRomData('roms/games/' + f, function(res) {
    msx.loadRom(res, 2, 2);
    $("#current-game").text(f);
  });
}

function getRomData(url, callback) {
  $.ajax({
    url: url,
    crossDomain: true,
    xhr: function() {
      var xhr = $.ajaxSettings.xhr();
      if (typeof xhr.overrideMimeType !== 'undefined') {
        // Download as binary
        xhr.overrideMimeType('text/plain; charset=x-user-defined');
      }
      return xhr;
    },
    complete: function(xhr, status) {
      console.log('Status:', status);
      callback(xhr.responseText);
    }
  });
}
</script>
</body>
</html>

